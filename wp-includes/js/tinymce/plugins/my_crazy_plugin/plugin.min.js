tinymce.PluginManager.add('my_crazy_plugin', function(editor) {
   var state;

   /* Actions to do on button click */
   function my_action() {
        state = !state; /* Switching state */
        editor.fire('mybutton', {state: state});

        if (state){
            alert(state); /* Do your true-stuff here */
        }
        else {
            alert(state); /* Do your false-stuff here */
        }
    }

    function toggleState_MyButton() {
        var self = this;
        editor.on('mybutton', function(e) {
            self.active(e.state);
        });
    }

    /* Adding the button & command */
    editor.addCommand('cmd_mybutton', my_action);

    editor.addButton('mybutton', {
        image: 'tinymce/plugins/my_crazy_plugin/img/some16x16icon.png',
        title: 'That Bubble Help text',
        cmd: 'cmd_mybutton',
        onPostRender: toggleState_MyButton
    });
});
